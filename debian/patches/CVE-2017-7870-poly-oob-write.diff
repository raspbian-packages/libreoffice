From 62a97e6a561ce65e88d4c537a1b82c336f012722 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Caol=C3=A1n=20McNamara?= <caolanm@redhat.com>
Date: Mon, 2 Jan 2017 11:53:31 +0000
Subject: [PATCH] ofz#372 check if ImplSplit succeeded

Change-Id: I1e34295fe3ee5f77e787f583616d52fa92a0eca4
---
 tools/inc/poly.h              |  2 +-
 tools/source/generic/poly.cxx | 13 +++++++++----
 2 files changed, 10 insertions(+), 5 deletions(-)

--- a/tools/inc/poly.h
+++ b/tools/inc/poly.h
@@ -60,7 +60,7 @@
 
     void            ImplSetSize( sal_uInt16 nSize, sal_Bool bResize = sal_True );
     void            ImplCreateFlagArray();
-    void            ImplSplit( sal_uInt16 nPos, sal_uInt16 nSpace, ImplPolygon* pInitPoly = NULL );
+    sal_Bool        ImplSplit( sal_uInt16 nPos, sal_uInt16 nSpace, ImplPolygon* pInitPoly = NULL );
 };
 
 // -------------------
--- a/tools/source/generic/poly.cxx
+++ b/tools/source/generic/poly.cxx
@@ -235,13 +235,13 @@
 
 // -----------------------------------------------------------------------
 
-void ImplPolygon::ImplSplit( sal_uInt16 nPos, sal_uInt16 nSpace, ImplPolygon* pInitPoly )
+sal_Bool ImplPolygon::ImplSplit( sal_uInt16 nPos, sal_uInt16 nSpace, ImplPolygon* pInitPoly )
 {
     const sal_uIntPtr   nSpaceSize = nSpace * sizeof( Point );
 
     //Can't fit this in :-(, throw ?
     if (mnPoints + nSpace > USHRT_MAX)
-        return;
+        return sal_False;
 
     const sal_uInt16    nNewSize = mnPoints + nSpace;
 
@@ -297,6 +297,8 @@
         mpPointAry = pNewAry;
         mnPoints   = nNewSize;
     }
+
+    return sal_True;
 }
 
 // -----------------------------------------------------------------------
@@ -1561,8 +1563,8 @@
     if( nPos >= mpImplPolygon->mnPoints )
         nPos = mpImplPolygon->mnPoints;
 
-    mpImplPolygon->ImplSplit( nPos, 1 );
-    mpImplPolygon->mpPointAry[ nPos ] = rPt;
+    if (mpImplPolygon->ImplSplit( nPos, 1 ))
+        mpImplPolygon->mpPointAry[ nPos ] = rPt;
 
     if( POLY_NORMAL != eFlags )
     {
